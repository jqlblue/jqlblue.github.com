<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: php | Jqlblue's Blog]]></title>
  <link href="http://jqlblue.github.io/tags/php/atom.xml" rel="self"/>
  <link href="http://jqlblue.github.io/"/>
  <updated>2014-04-09T18:57:52+08:00</updated>
  <id>http://jqlblue.github.io/</id>
  <author>
    <name><![CDATA[jqlblue]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[如何静态编译php]]></title>
    <link href="http://jqlblue.github.io/blog/2014/04/09/statically-compile-php/"/>
    <updated>2014-04-09T18:13:00+08:00</updated>
    <id>http://jqlblue.github.io/blog/2014/04/09/statically-compile-php</id>
    <content type="html"><![CDATA[<p>有些时候，我们写了一个php脚本，但是对方的服务器上没有php环境。</p>

<p>这时，我们可以通过静态方式编译php，并将相关扩展一起打包进php可执行文件，然后在运行脚本时指定php binary。</p>

<p>安装步骤如下：</p>

<ul>
<li><p>准备源文件
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>install.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget -c &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://www.php.net/get/php-5.5.11.tar.gz/from/this/mirror&quot;</span>&gt;http://www.php.net/get/php-5.5.11.tar.gz/from/this/mirror&lt;/a&gt;
</span><span class='line'>tar zxvf php-5.5.11.tar.gz
</span><span class='line'>wget &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://pecl.php.net/get/redis-2.2.5.tgz&quot;</span>&gt;http://pecl.php.net/get/redis-2.2.5.tgz&lt;/a&gt;
</span><span class='line'>tar xvf redis-2.2.5.tgz
</span><span class='line'>mv redis-2.2.5 php-5.5.11/ext/redis
</span></code></pre></td></tr></table></div></figure></notextile></div></p></li>
<li><p>重新生成configure
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>install.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd </span>php-5.5.11
</span><span class='line'>rm -f ./configure
</span><span class='line'>./buildconf &amp;mdash;force
</span></code></pre></td></tr></table></div></figure></notextile></div></p></li>
<li><p>configure
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>install.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./configure <span class="nv">LDFLAGS</span><span class="o">=</span>-static <span class="se">\</span>
</span><span class='line'>&amp;mdash;prefix<span class="o">=</span>/usr/local/php5-static <span class="se">\</span>
</span><span class='line'>&amp;mdash;disable-all <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-shared<span class="o">=</span>no <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-static<span class="o">=</span>yes <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-inline-optimization <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-hash <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-mbstring <span class="se">\</span>
</span><span class='line'>&amp;mdash;with-layout<span class="o">=</span>GNU <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-filter <span class="se">\</span>
</span><span class='line'>&amp;mdash;with-pcre-regex <span class="se">\</span>
</span><span class='line'>&amp;mdash;with-zlib <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-json <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-ctype <span class="se">\</span>
</span><span class='line'>&amp;mdash;disable-redis-session <span class="se">\</span>
</span><span class='line'>&amp;mdash;enable-redis
</span></code></pre></td></tr></table></div></figure></notextile></div></p></li>
<li><p>修改Makefile</p></li>
</ul>


<p>将</p>

<pre><code>BUILD_CLI = $(LIBTOOL) --mode=link $(CC) -export-dynamic $(CFLAGS_CLEAN) $(EXTRA_CFLAGS) $(EXTRA_LDFLAGS_PROGRAM) $(LDFLAGS) $(PHP_RPATHS) $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_CLI_OBJS) $(EXTRA_LIBS) $(ZEND_EXTRA_LIBS) -o $(SAPI_CLI_PATH)
BUILD_CGI = $(LIBTOOL) --mode=link $(CC) -export-dynamic $(CFLAGS_CLEAN) $(EXTRA_CFLAGS) $(EXTRA_LDFLAGS_PROGRAM) $(LDFLAGS) $(PHP_RPATHS) $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_CGI_OBJS) $(EXTRA_LIBS) $(ZEND_EXTRA_LIBS) -o $(SAPI_CGI_PATH)
</code></pre>

<p>替换成</p>

<pre><code>BUILD_CLI = $(LIBTOOL) --mode=link $(CC) $(CFLAGS_CLEAN) $(EXTRA_CFLAGS) $(EXTRA_LDFLAGS_PROGRAM) $(LDFLAGS) $(PHP_RPATHS) $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_CLI_OBJS) $(EXTRA_LIBS) $(ZEND_EXTRA_LIBS) -all-static -o $(SAPI_CLI_PATH)
BUILD_CGI = $(LIBTOOL) --mode=link $(CC) $(CFLAGS_CLEAN) $(EXTRA_CFLAGS) $(EXTRA_LDFLAGS_PROGRAM) $(LDFLAGS) $(PHP_RPATHS) $(PHP_GLOBAL_OBJS) $(PHP_BINARY_OBJS) $(PHP_CGI_OBJS) $(EXTRA_LIBS) $(ZEND_EXTRA_LIBS) -all-static -o $(SAPI_CGI_PATH)
</code></pre>

<p>即：</p>

<p>在<code>BUILD_CLI</code>和<code>BUILD_CGI</code>对应的行中移除<code>-export-dynamic</code>，在<code>-o $(SAPI_CGI_PATH)</code>和<code>-o $(SAPI_CLI_PATH)</code>之前，添加<code>-all-static</code></p>

<ul>
<li>继续安装</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>install.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>make <span class="nv">LDFLAGS</span><span class="o">=</span>-ldl
</span><span class='line'>sudo make install
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<ul>
<li>检查</li>
</ul>


<p>在命令行执行</p>

<pre><code>$ file /usr/local/php5-static/bin/php
/usr/local/php5-static/bin/php: ELF 64-bit LSB executable, AMD x86-64, version 1 (SYSV), for GNU/Linux 2.6.9, statically linked, for GNU/Linux 2.6.9, not stripped

$ /usr/local/php5-static/bin/php -m
[PHP Modules]
Core
ctype
date
ereg
filter
hash
json
mbstring
pcre
redis
Reflection
SPL
standard
zlib

[Zend Modules]
</code></pre>

<p>因为可执行文件中包含了调试信息，所以体积较大</p>

<pre><code>$ ll -h /usr/local/php5-static/bin/php
-rwxr-xr-x 1 root root 18M 04-09 18:11 /usr/local/php5-static/bin/php
</code></pre>

<p>可以通过<code>strip</code>命令移除调试信息</p>

<pre><code>$ sudo strip /usr/local/php5-static/bin/php
$ ll -h /usr/local/php5-static/bin/php
-rwxr-xr-x 1 root root 6.1M 04-09 18:11 /usr/local/php5-static/bin/php
</code></pre>

<p>reference：</p>

<p>[^1] <a href="http://www.php.net/manual/zh/install.pecl.static.php">http://www.php.net/manual/zh/install.pecl.static.php</a></p>

<p>[^2] <a href="http://d.hatena.ne.jp/shimooka/comment/20110216/1297827454">http://d.hatena.ne.jp/shimooka/comment/20110216/1297827454</a></p>

<p>[^3] <a href="http://www.gnu.org/software/libtool/manual/html_node/Link-mode.html#Link-mode">http://www.gnu.org/software/libtool/manual/html_node/Link-mode.html#Link-mode</a></p>

<p>[^4] <a href="http://markmail.org/message/cpoenglavs4vwv32#query:+page:1+mid:cpoenglavs4vwv32+state:results">http://markmail.org/message/cpoenglavs4vwv32#query:+page:1+mid:cpoenglavs4vwv32+state:results</a></p>
]]></content>
  </entry>
  
</feed>
